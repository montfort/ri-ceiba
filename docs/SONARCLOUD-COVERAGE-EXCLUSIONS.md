# SonarCloud Coverage Exclusions

## Overview

This document describes the code coverage exclusions configured in our SonarCloud analysis pipeline (`.github/workflows/sonar.yml`) and provides technical justification for each exclusion.

**Last Updated:** 2025-12-15
**Configuration File:** `.github/workflows/sonar.yml`

## Coverage Exclusion Categories

Our exclusions fall into three categories:

1. **Auto-generated Code** - Code generated by tools/frameworks that should not be manually tested
2. **Infrastructure/Boilerplate Code** - Framework configuration that has no business logic
3. **Data Definition Code** - Types, interfaces, and DTOs that contain no executable logic

## Detailed Exclusions

### 1. Auto-Generated Code

#### `**/Migrations/**`
**Reason:** Entity Framework Core migrations are auto-generated by the `dotnet ef migrations add` command. These files contain database schema changes represented as C# code.

- **Why exclude:** Testing migrations would essentially test EF Core itself, not our application logic
- **Risk mitigation:** Migrations are validated during integration tests when the database is created
- **Alternative validation:** Manual review during code review process

#### `**/*.Designer.cs`
**Reason:** Designer files are auto-generated by Visual Studio for WinForms, Resources, and Settings files.

- **Why exclude:** These files are regenerated automatically and should never be manually modified
- **Risk mitigation:** The source files (`.resx`, `.settings`) are the actual configuration
- **Note:** Currently not used in this project but excluded preemptively

#### `**/obj/**/System.Text.RegularExpressions.Generator/**`
**Reason:** .NET 7+ Regex source generators create optimized regex implementations at compile time.

- **Why exclude:** Generated code that implements `[GeneratedRegex]` attributes
- **Risk mitigation:** The regex patterns themselves are tested via unit tests
- **Technical detail:** These files appear in `obj/` during compilation

---

### 2. Infrastructure/Boilerplate Code

#### `**/Program.cs`
**Reason:** The application entry point contains only startup configuration and dependency injection setup.

- **Why exclude:** Contains no business logic, only framework bootstrapping
- **Content:** Service registration, middleware pipeline, configuration binding
- **Risk mitigation:** Integration tests verify the application starts correctly
- **Lines:** ~50-100 lines of configuration code

#### `**/GlobalUsings.cs`
**Reason:** Global using directives file introduced in C# 10 for implicit usings.

- **Why exclude:** Contains only `global using` statements, no executable code
- **Content:** Namespace imports that apply project-wide

#### `**/Data/Configurations/**`
**Reason:** Entity Framework Core Fluent API configurations for entity mappings.

- **Why exclude:** Declarative configuration code defining database schema
- **Content:** `IEntityTypeConfiguration<T>` implementations with column mappings, relationships, indexes
- **Risk mitigation:** Validated via integration tests that create/query the database
- **Example files:** `UsuarioConfiguration.cs`, `ReporteIncidenciaConfiguration.cs`

---

### 3. Data Definition Code (No Executable Logic)

#### `**/Interfaces/**`
**Reason:** Interface definitions contain only method signatures, no implementation.

- **Why exclude:** Interfaces have no executable code to cover
- **Content:** `IReportService`, `IUserManagementService`, etc.
- **Note:** The implementations ARE covered by tests

#### `**/DTOs/**`
**Reason:** Data Transfer Objects are simple POCO classes with properties only.

- **Why exclude:** No methods or logic to test, just data containers
- **Content:** `ReportDto`, `UserDto`, `CreateReportDto`, etc.
- **Risk mitigation:** DTOs are exercised through service layer tests
- **Exception:** DTOs with validation attributes are indirectly tested via validation tests

#### `**/Enums/**`
**Reason:** Enum definitions contain only constant values.

- **Why exclude:** No executable logic in enum definitions
- **Content:** `EstadoReporte`, `UserRole`, etc.

#### `**/Entities/**`
**Reason:** Domain entities are data models with properties and minimal logic.

- **Why exclude:** Primarily data holders with auto-properties
- **Content:** `Usuario`, `ReporteIncidencia`, `ConfiguracionIA`, etc.
- **Note:** Any entity methods with logic should be tested and may need review
- **Risk mitigation:** Entity behavior is tested through repository/service tests

#### `**/Exceptions/**`
**Reason:** Custom exception classes with no business logic.

- **Why exclude:** Exception classes only define constructors passing messages to base
- **Content:** `ReportNotFoundException`, `UnauthorizedAccessException`, etc.
- **Risk mitigation:** Exception throwing/catching is tested in service tests

---

### 4. Blazor Infrastructure Components

These components are part of the Blazor framework infrastructure and contain minimal or no testable business logic.

#### `**/App.razor`
**Reason:** Root Blazor component that only sets up routing infrastructure.

- **Why exclude:** Contains only `<Router>` and `<RouteView>` components
- **Content:** ~15 lines of routing setup
- **No business logic:** Just framework wiring

#### `**/Routes.razor`
**Reason:** Route definition component for Blazor routing.

- **Why exclude:** Pure routing configuration
- **Content:** Route mappings and layouts

#### `**/MainLayout.razor`
**Reason:** Main application layout wrapper.

- **Why exclude:** HTML structure with `@Body` placeholder
- **Content:** Navigation, header, footer structure
- **Testing approach:** E2E tests verify layout renders correctly

#### `**/NavMenu.razor`
**Reason:** Navigation menu component.

- **Why exclude:** Static navigation links based on user role
- **Content:** `<NavLink>` components with route definitions
- **Testing approach:** E2E tests verify navigation works

#### `**/ReconnectModal.razor`
**Reason:** Blazor Server SignalR reconnection modal.

- **Why exclude:** Framework-provided reconnection UI
- **Content:** Modal shown when SignalR connection drops
- **No custom logic:** Uses Blazor's built-in reconnection mechanism

#### `**/_Imports.razor`
**Reason:** Global Blazor namespace imports.

- **Why exclude:** Contains only `@using` directives
- **Content:** Namespace imports for all Razor components

#### `**/Error.razor`
**Reason:** Error boundary fallback component.

- **Why exclude:** Simple error display with no logic
- **Content:** Error message and stack trace display
- **Testing approach:** Error handling tested via integration tests

#### `**/Logout.razor`
**Reason:** Logout endpoint component.

- **Why exclude:** Single-purpose component calling SignOut
- **Content:** ~10 lines calling `SignOutManager`
- **Testing approach:** Authentication flow tested via E2E

#### `**/RedirectToLogin.razor`
**Reason:** Authentication redirect helper component.

- **Why exclude:** Simple redirect logic
- **Content:** Redirects unauthorized users to login page
- **Testing approach:** Authorization tested via integration tests

#### `**/SkipLink.razor`
**Reason:** Accessibility skip navigation link.

- **Why exclude:** WCAG accessibility feature with no business logic
- **Content:** "Skip to main content" link for screen readers

---

## Test Coverage Strategy

### What IS Covered

Despite exclusions, our test suite covers:

| Layer | Coverage Target | Test Type |
|-------|-----------------|-----------|
| Core Services | 90%+ | Unit tests |
| Application Services | 80%+ | Unit + Integration tests |
| Infrastructure | 70%+ | Integration tests |
| Blazor Components | 70%+ | bUnit component tests |
| API Endpoints | 80%+ | Integration tests |

### Test Projects

- `Ceiba.Core.Tests` - 447 unit tests
- `Ceiba.Application.Tests` - 338 service tests
- `Ceiba.Infrastructure.Tests` - 688 integration tests
- `Ceiba.Web.Tests` - 742 component tests
- `Ceiba.Integration.Tests` - 250 E2E tests

### bUnit Component Tests

We have comprehensive bUnit tests for business-logic components:

| Component | Lines | Tests | Coverage Focus |
|-----------|-------|-------|----------------|
| AiConfigManager.razor | 637 | 23 | AI config CRUD |
| ExportPage.razor | 545 | 15 | Report export |
| ReportListRevisor.razor | 536 | 16 | Supervisor view |
| SuggestionManager.razor | 421 | 21 | Suggestion CRUD |
| AutomatedReportDetail.razor | 418 | 21 | Report details |
| UserForm.razor | 406 | 25 | User management |
| TemplateList.razor | 393 | 22 | Template CRUD |

---

## Duplication Exclusions (`sonar.cpd.exclusions`)

```
**/Migrations/**
**/Data/Configurations/**
```

**Reason:** These files have intentionally similar structure:
- Migrations follow EF Core patterns with repeated `Up()`/`Down()` methods
- Entity configurations have similar Fluent API patterns

---

## Full Exclusions (`sonar.exclusions`)

```
**/wwwroot/**
**/Migrations/**
**/obj/**
**/scripts/**
**/bin/**
```

These are excluded from all analysis (not just coverage):

- `wwwroot/` - Static assets (CSS, JS, images)
- `obj/` - Build intermediates
- `bin/` - Build outputs
- `scripts/` - Utility scripts (bash, PowerShell)

---

## Configuration Reference

### Current sonar.yml Configuration

```yaml
/d:sonar.coverage.exclusions="**/Migrations/**,**/Tests/**,**/*.Designer.cs,**/obj/**/System.Text.RegularExpressions.Generator/**,**/Data/Configurations/**,**/Interfaces/**,**/DTOs/**,**/Enums/**,**/Entities/**,**/Exceptions/**,**/Program.cs,**/GlobalUsings.cs,**/App.razor,**/Routes.razor,**/MainLayout.razor,**/NavMenu.razor,**/ReconnectModal.razor,**/_Imports.razor,**/Error.razor,**/Logout.razor,**/RedirectToLogin.razor,**/SkipLink.razor"
```

### How to Modify

1. Edit `.github/workflows/sonar.yml`
2. Locate the `sonar.coverage.exclusions` parameter
3. Add/remove patterns using glob syntax
4. Commit and push - changes apply on next CI run

### Glob Pattern Reference

| Pattern | Matches |
|---------|---------|
| `**/Migrations/**` | Any file under any Migrations folder |
| `**/*.Designer.cs` | Any .Designer.cs file |
| `**/Program.cs` | Any Program.cs at any level |

---

## Review Schedule

These exclusions should be reviewed:
- **Quarterly:** Ensure no business logic has been added to excluded files
- **On major refactoring:** When architecture changes significantly
- **When coverage drops:** Investigate if exclusions are too broad

---

## References

- [SonarCloud Test Coverage Documentation](https://docs.sonarsource.com/sonarqube-cloud/enriching/test-coverage/dotnet-test-coverage)
- [SonarQube Analysis Parameters](https://docs.sonarsource.com/sonarqube-cloud/advanced-setup/analysis-scope)
- [Coverlet Documentation](https://github.com/coverlet-coverage/coverlet)
- [bUnit Testing Library](https://bunit.dev/)
