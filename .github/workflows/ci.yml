name: CI Pipeline

on:
  push:
    branches: [ main, develop, '001-*' ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

permissions:
  contents: read
  checks: write
  pull-requests: write

env:
  DOTNET_VERSION: '10.0.x'
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  DOTNET_NOLOGO: true
  # CI database credentials - ephemeral containers only, not a real secret
  # Using env var to avoid SonarQube hardcoded credential warnings
  CI_DB_PASSWORD: ${{ secrets.CI_DB_PASSWORD || 'CeibaE2E_Ci_2025!' }}

jobs:
  # Build and Unit Tests
  build-and-test:
    name: Build & Unit Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup .NET
        uses: actions/setup-dotnet@67a3573c9a986a3f9c594539f4ab511d57bb3ce9 # v4.3.1
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Cache NuGet packages
        uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684 # v4.2.3
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj', '**/Directory.Build.props') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Restore dependencies
        run: dotnet restore

      - name: Build solution
        run: dotnet build --no-restore --configuration Release

      - name: Run Unit Tests (Core)
        run: dotnet test tests/Ceiba.Core.Tests/Ceiba.Core.Tests.csproj --no-build --configuration Release --verbosity normal --logger "trx;LogFileName=core-tests.trx" --results-directory ./TestResults

      - name: Run Unit Tests (Application)
        run: dotnet test tests/Ceiba.Application.Tests/Ceiba.Application.Tests.csproj --no-build --configuration Release --verbosity normal --logger "trx;LogFileName=application-tests.trx" --results-directory ./TestResults

      - name: Run Unit Tests (Infrastructure)
        run: dotnet test tests/Ceiba.Infrastructure.Tests/Ceiba.Infrastructure.Tests.csproj --no-build --configuration Release --verbosity normal --logger "trx;LogFileName=infrastructure-tests.trx" --results-directory ./TestResults

      - name: Run Component Tests (Web/bUnit)
        run: dotnet test tests/Ceiba.Web.Tests/Ceiba.Web.Tests.csproj --no-build --configuration Release --verbosity normal --logger "trx;LogFileName=web-tests.trx" --results-directory ./TestResults

      - name: Publish Test Results
        uses: EnricoMi/publish-unit-test-result-action@170bf24d20d201b842d7a52403b73ed297e6645b # v2.18.0
        if: always()
        with:
          files: ./TestResults/*.trx
          check_name: Unit Test Results
          comment_mode: always

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: unit-test-results
          path: ./TestResults
          retention-days: 14

  # Integration Tests (requires PostgreSQL)
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: build-and-test

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_DB: ceiba_test
          POSTGRES_USER: ceiba
          POSTGRES_PASSWORD: ceiba_test_password
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj', '**/Directory.Build.props') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Restore dependencies
        run: dotnet restore

      - name: Build solution
        run: dotnet build --no-restore --configuration Release

      - name: Run Integration Tests
        run: dotnet test tests/Ceiba.Integration.Tests/Ceiba.Integration.Tests.csproj --no-build --configuration Release --filter "Category!=E2E&Category!=PostgreSQL" --verbosity normal --logger "trx;LogFileName=integration-tests.trx" --results-directory ./TestResults
        env:
          ConnectionStrings__DefaultConnection: "Host=localhost;Database=ceiba_test;Username=ceiba;Password=ceiba_test_password"
          CEIBA_TEST_PG_HOST: localhost
          CEIBA_TEST_PG_PORT: "5432"
          CEIBA_TEST_PG_USER: ceiba
          CEIBA_TEST_PG_PASSWORD: ceiba_test_password

      - name: Publish Integration Test Results
        uses: EnricoMi/publish-unit-test-result-action@170bf24d20d201b842d7a52403b73ed297e6645b # v2.18.0
        if: always()
        with:
          files: ./TestResults/*.trx
          check_name: Integration Test Results
          comment_mode: always

      - name: Upload Integration Test Results
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: integration-test-results
          path: ./TestResults
          retention-days: 14

  # E2E Tests with Playwright
  e2e-tests:
    name: E2E Tests (Playwright)
    runs-on: ubuntu-latest
    needs: build-and-test

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_DB: ceiba_e2e
          POSTGRES_USER: ceiba
          POSTGRES_PASSWORD: ${{ env.CI_DB_PASSWORD }}
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj', '**/Directory.Build.props') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Restore dependencies
        run: dotnet restore

      - name: Build solution
        run: dotnet build --no-restore --configuration Release

      - name: Install Playwright browsers
        run: |
          cd tests/Ceiba.Integration.Tests
          dotnet build
          pwsh bin/Release/net10.0/playwright.ps1 install --with-deps chromium

      - name: Run database migrations
        run: |
          dotnet tool install --global dotnet-ef || true
          export PATH="$PATH:$HOME/.dotnet/tools"
          echo "Running migrations..."
          # Use connection string directly via command line argument to avoid env var issues
          dotnet ef database update \
            --project src/Ceiba.Infrastructure \
            --startup-project src/Ceiba.Web \
            --connection "Host=localhost;Database=ceiba_e2e;Username=ceiba;Password=${{ env.CI_DB_PASSWORD }}" \
            --verbose
          echo "Verifying database tables..."
          PGPASSWORD="${{ env.CI_DB_PASSWORD }}" psql -h localhost -U ceiba -d ceiba_e2e -c "\dt" || echo "Could not list tables (psql not installed)"

      - name: Start application
        run: |
          cd src/Ceiba.Web
          echo "Starting application..."
          # Use --no-launch-profile to ignore launchSettings.json and respect env vars
          nohup dotnet run --no-build --configuration Release --no-launch-profile > app.log 2>&1 &
          APP_PID=$!
          echo $APP_PID > app.pid
          echo "Application started with PID: $APP_PID"
          sleep 5
          echo "=== Initial app logs: ==="
          head -50 app.log || true
        env:
          ASPNETCORE_ENVIRONMENT: Testing
          ASPNETCORE_URLS: "http://localhost:5000"
          ConnectionStrings__DefaultConnection: "Host=localhost;Database=ceiba_e2e;Username=ceiba;Password=${{ env.CI_DB_PASSWORD }}"

      - name: Wait for application
        run: |
          echo "Waiting for application to start..."
          for i in {1..60}; do
            # Check if process is still running
            if [ -f src/Ceiba.Web/app.pid ]; then
              PID=$(cat src/Ceiba.Web/app.pid)
              if ! kill -0 $PID 2>/dev/null; then
                echo "=== Application process died! ==="
                echo "=== App logs: ==="
                cat src/Ceiba.Web/app.log || true
                exit 1
              fi
            fi
            # Check health endpoint
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:5000/health 2>/dev/null || echo "000")
            if [ "$HTTP_CODE" = "200" ]; then
              echo "Application is ready! (HTTP $HTTP_CODE)"
              exit 0
            fi
            echo "Waiting... ($i/60) - HTTP: $HTTP_CODE"
            sleep 2
          done
          echo "=== Application failed to start ==="
          echo "=== App logs: ==="
          cat src/Ceiba.Web/app.log || true
          exit 1

      - name: Run E2E Tests
        run: dotnet test tests/Ceiba.Integration.Tests/Ceiba.Integration.Tests.csproj --no-build --configuration Release --filter "Category=E2E" --verbosity normal --logger "trx;LogFileName=e2e-tests.trx" --results-directory ./TestResults
        env:
          BASE_URL: "http://localhost:5000"
          ConnectionStrings__DefaultConnection: "Host=localhost;Database=ceiba_e2e;Username=ceiba;Password=${{ env.CI_DB_PASSWORD }}"

      - name: Upload Playwright traces
        if: failure()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: playwright-traces
          path: tests/Ceiba.Integration.Tests/bin/Release/net10.0/playwright-traces/
          retention-days: 7

      - name: Upload E2E Test Results
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: e2e-test-results
          path: ./TestResults
          retention-days: 14

  # Code Coverage Report
  coverage:
    name: Code Coverage
    runs-on: ubuntu-latest
    needs: build-and-test

    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup .NET
        uses: actions/setup-dotnet@67a3573c9a986a3f9c594539f4ab511d57bb3ce9 # v4.3.1
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Cache NuGet packages
        uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684 # v4.2.3
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj', '**/Directory.Build.props') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Restore dependencies
        run: dotnet restore

      - name: Build solution
        run: dotnet build --no-restore --configuration Release

      - name: Run tests with coverage
        run: |
          dotnet test --no-build --configuration Release \
            --filter "Category!=E2E&Category!=PostgreSQL" \
            --collect:"XPlat Code Coverage" \
            --results-directory ./coverage \
            --settings coverlet.runsettings \
            -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Format=cobertura

      - name: Generate coverage report
        uses: danielpalme/ReportGenerator-GitHub-Action@ee0ae774f6d3afedcbd1683c1ab21b83670bdf8e # v5.5.1
        with:
          reports: 'coverage/**/coverage.cobertura.xml'
          targetdir: 'coveragereport'
          reporttypes: 'HtmlInline;Cobertura;Badges'

      - name: Upload coverage report
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: coverage-report
          path: coveragereport
          retention-days: 14

      - name: Coverage Summary
        uses: irongut/CodeCoverageSummary@51cc3a756ddcd398d447c044c02cb6aa83fdae95 # v1.3.0
        with:
          filename: coverage/**/coverage.cobertura.xml
          badge: true
          format: markdown
          output: both
          thresholds: '60 80'

      - name: Add Coverage PR Comment
        uses: marocchino/sticky-pull-request-comment@52423e01640425a022ef5fd42c6fb5f633a02728 # v2.9.1
        if: github.event_name == 'pull_request'
        with:
          recreate: true
          path: code-coverage-results.md

  # Build Summary
  build-summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [build-and-test, integration-tests, e2e-tests, coverage]
    if: always()

    steps:
      - name: Create Build Summary
        run: |
          echo "# CI Pipeline Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Build & Unit Tests | ${{ needs.build-and-test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Integration Tests | ${{ needs.integration-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| E2E Tests | ${{ needs.e2e-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Code Coverage | ${{ needs.coverage.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Build completed at:** $(date -u)" >> $GITHUB_STEP_SUMMARY
