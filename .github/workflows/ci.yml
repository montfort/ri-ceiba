name: CI Pipeline

on:
  push:
    branches: [ main, develop, '001-*' ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

permissions:
  contents: read
  checks: write
  pull-requests: write

env:
  DOTNET_VERSION: '10.0.x'
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  DOTNET_NOLOGO: true

jobs:
  # Build and Unit Tests
  build-and-test:
    name: Build & Unit Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj', '**/Directory.Build.props') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Restore dependencies
        run: dotnet restore

      - name: Build solution
        run: dotnet build --no-restore --configuration Release

      - name: Run Unit Tests (Core)
        run: dotnet test tests/Ceiba.Core.Tests/Ceiba.Core.Tests.csproj --no-build --configuration Release --verbosity normal --logger "trx;LogFileName=core-tests.trx" --results-directory ./TestResults

      - name: Run Unit Tests (Application)
        run: dotnet test tests/Ceiba.Application.Tests/Ceiba.Application.Tests.csproj --no-build --configuration Release --verbosity normal --logger "trx;LogFileName=application-tests.trx" --results-directory ./TestResults

      - name: Run Unit Tests (Infrastructure)
        run: dotnet test tests/Ceiba.Infrastructure.Tests/Ceiba.Infrastructure.Tests.csproj --no-build --configuration Release --verbosity normal --logger "trx;LogFileName=infrastructure-tests.trx" --results-directory ./TestResults

      - name: Run Component Tests (Web/bUnit)
        run: dotnet test tests/Ceiba.Web.Tests/Ceiba.Web.Tests.csproj --no-build --configuration Release --verbosity normal --logger "trx;LogFileName=web-tests.trx" --results-directory ./TestResults

      - name: Publish Test Results
        uses: EnricoMi/publish-unit-test-result-action@v2
        if: always()
        with:
          files: ./TestResults/*.trx
          check_name: Unit Test Results
          comment_mode: always

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-results
          path: ./TestResults
          retention-days: 14

  # Integration Tests (requires PostgreSQL)
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: build-and-test

    services:
      postgres:
        image: postgres:18-alpine
        env:
          POSTGRES_DB: ceiba_test
          POSTGRES_USER: ceiba
          POSTGRES_PASSWORD: ceiba123
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj', '**/Directory.Build.props') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Restore dependencies
        run: dotnet restore

      - name: Build solution
        run: dotnet build --no-restore --configuration Release

      - name: Run Integration Tests
        run: dotnet test tests/Ceiba.Integration.Tests/Ceiba.Integration.Tests.csproj --no-build --configuration Release --verbosity normal --logger "trx;LogFileName=integration-tests.trx" --results-directory ./TestResults
        env:
          ConnectionStrings__DefaultConnection: "Host=localhost;Database=ceiba_test;Username=ceiba;Password=ceiba123"

      - name: Publish Integration Test Results
        uses: EnricoMi/publish-unit-test-result-action@v2
        if: always()
        with:
          files: ./TestResults/*.trx
          check_name: Integration Test Results
          comment_mode: always

      - name: Upload Integration Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-results
          path: ./TestResults
          retention-days: 14

  # E2E Tests with Playwright
  e2e-tests:
    name: E2E Tests (Playwright)
    runs-on: ubuntu-latest
    needs: build-and-test

    services:
      postgres:
        image: postgres:18-alpine
        env:
          POSTGRES_DB: ceiba_e2e
          POSTGRES_USER: ceiba
          POSTGRES_PASSWORD: ceiba123
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj', '**/Directory.Build.props') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Restore dependencies
        run: dotnet restore

      - name: Build solution
        run: dotnet build --no-restore --configuration Release

      - name: Install Playwright browsers
        run: |
          cd tests/Ceiba.Integration.Tests
          dotnet build
          pwsh bin/Release/net10.0/playwright.ps1 install --with-deps chromium

      - name: Run database migrations
        run: |
          dotnet tool install --global dotnet-ef || true
          dotnet ef database update --project src/Ceiba.Infrastructure --startup-project src/Ceiba.Web
        env:
          ConnectionStrings__DefaultConnection: "Host=localhost;Database=ceiba_e2e;Username=ceiba;Password=ceiba123"

      - name: Start application
        run: |
          cd src/Ceiba.Web
          dotnet run --no-build --configuration Release &
          sleep 30
        env:
          ASPNETCORE_ENVIRONMENT: Testing
          ASPNETCORE_URLS: "http://localhost:5000"
          ConnectionStrings__DefaultConnection: "Host=localhost;Database=ceiba_e2e;Username=ceiba;Password=ceiba123"

      - name: Wait for application
        run: |
          for i in {1..30}; do
            if curl -f http://localhost:5000/health 2>/dev/null; then
              echo "Application is ready"
              exit 0
            fi
            echo "Waiting for application... ($i/30)"
            sleep 2
          done
          echo "Application failed to start"
          exit 1

      - name: Run E2E Tests
        run: dotnet test tests/Ceiba.Integration.Tests/Ceiba.Integration.Tests.csproj --no-build --configuration Release --filter "Category=E2E" --verbosity normal --logger "trx;LogFileName=e2e-tests.trx" --results-directory ./TestResults
        env:
          BASE_URL: "http://localhost:5000"
          ConnectionStrings__DefaultConnection: "Host=localhost;Database=ceiba_e2e;Username=ceiba;Password=ceiba123"

      - name: Upload Playwright traces
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-traces
          path: tests/Ceiba.Integration.Tests/bin/Release/net10.0/playwright-traces/
          retention-days: 7

      - name: Upload E2E Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-results
          path: ./TestResults
          retention-days: 14

  # Code Coverage Report
  coverage:
    name: Code Coverage
    runs-on: ubuntu-latest
    needs: build-and-test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj', '**/Directory.Build.props') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Restore dependencies
        run: dotnet restore

      - name: Build solution
        run: dotnet build --no-restore --configuration Release

      - name: Run tests with coverage
        run: |
          dotnet test --no-build --configuration Release \
            --collect:"XPlat Code Coverage" \
            --results-directory ./coverage \
            --settings coverlet.runsettings \
            -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Format=cobertura

      - name: Generate coverage report
        uses: danielpalme/ReportGenerator-GitHub-Action@5
        with:
          reports: 'coverage/**/coverage.cobertura.xml'
          targetdir: 'coveragereport'
          reporttypes: 'HtmlInline;Cobertura;Badges'

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coveragereport
          retention-days: 14

      - name: Coverage Summary
        uses: irongut/CodeCoverageSummary@v1.3.0
        with:
          filename: coverage/**/coverage.cobertura.xml
          badge: true
          format: markdown
          output: both
          thresholds: '60 80'

      - name: Add Coverage PR Comment
        uses: marocchino/sticky-pull-request-comment@v2
        if: github.event_name == 'pull_request'
        with:
          recreate: true
          path: code-coverage-results.md

  # Build Summary
  build-summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [build-and-test, integration-tests, e2e-tests, coverage]
    if: always()

    steps:
      - name: Create Build Summary
        run: |
          echo "# CI Pipeline Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Build & Unit Tests | ${{ needs.build-and-test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Integration Tests | ${{ needs.integration-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| E2E Tests | ${{ needs.e2e-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Code Coverage | ${{ needs.coverage.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Build completed at:** $(date -u)" >> $GITHUB_STEP_SUMMARY
