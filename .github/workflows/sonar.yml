name: SonarQube Analysis

on:
  push:
    branches: [ main, develop, '001-*' ]
  pull_request:
    branches: [ main, develop ]
    types: [opened, synchronize, reopened]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: read

env:
  DOTNET_VERSION: '10.0.x'
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  DOTNET_NOLOGO: true

jobs:
  sonarqube:
    name: SonarQube Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0  # Full history for better analysis

      - name: Setup .NET
        uses: actions/setup-dotnet@67a3573c9a986a3f9c594539f4ab511d57bb3ce9 # v4.3.1
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Set up JDK 17
        uses: actions/setup-java@c5195efecf7bdfc987ee8bae7a71cb8b11521c00 # v4.7.1
        with:
          java-version: 17
          distribution: 'zulu'

      - name: Cache SonarQube packages
        uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684 # v4.2.3
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar

      - name: Cache NuGet packages
        uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684 # v4.2.3
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj', '**/Directory.Build.props') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Install SonarScanner for .NET
        run: dotnet tool install --global dotnet-sonarscanner

      - name: Restore dependencies
        run: dotnet restore

      - name: Begin SonarQube analysis
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          dotnet sonarscanner begin \
            /k:"montfort_ri-ceiba" \
            /o:"montfort" \
            /d:sonar.token="${SONAR_TOKEN}" \
            /d:sonar.host.url="https://sonarcloud.io" \
            /d:sonar.cs.opencover.reportsPaths="./coverage/coverage.opencover.xml,./TestResults/**/coverage.opencover.xml" \
            /d:sonar.cs.vstest.reportsPaths="**/TestResults/**/*.trx" \
            /d:sonar.coverage.exclusions="**/Migrations/**,**/Tests/**,**/*.Designer.cs,**/obj/**/System.Text.RegularExpressions.Generator/**,**/Data/Configurations/**,**/Interfaces/**,**/DTOs/**,**/Enums/**,**/Entities/**,**/Exceptions/**,**/Program.cs,**/GlobalUsings.cs" \
            /d:sonar.cpd.exclusions="**/Migrations/**,**/Data/Configurations/**" \
            /d:sonar.exclusions="**/wwwroot/**,**/Migrations/**,**/obj/**,**/scripts/**,**/bin/**" \
            /d:sonar.issue.ignore.multicriteria="e1" \
            /d:sonar.issue.ignore.multicriteria.e1.ruleKey="csharpsquid:S2696" \
            /d:sonar.issue.ignore.multicriteria.e1.resourceKey="**/LiveAnnouncer.razor" \
            /d:sonar.verbose=true

      - name: Build solution
        run: dotnet build --no-restore --no-incremental

      - name: Run tests with coverage
        run: |
          dotnet test --no-build \
            --filter "Category!=E2E&Collection!=PostgreSQL" \
            --collect:"XPlat Code Coverage" \
            --results-directory ./TestResults \
            --settings coverlet.runsettings \
            --logger "trx;LogFileName=test-results.trx" \
            -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Format=opencover

      - name: Install ReportGenerator
        run: dotnet tool install --global dotnet-reportgenerator-globaltool

      - name: Merge coverage reports
        run: |
          echo "=== Coverage files generated ==="
          find . -name "coverage.opencover.xml" -type f
          echo ""

          # Count coverage files
          COVERAGE_COUNT=$(find ./TestResults -name "coverage.opencover.xml" -type f | wc -l)
          echo "Found $COVERAGE_COUNT coverage file(s)"

          if [ "$COVERAGE_COUNT" -gt 0 ]; then
            # Show content sample from first coverage file for debugging
            echo ""
            echo "=== Sample from first coverage file (checking file paths) ==="
            FIRST_FILE=$(find ./TestResults -name "coverage.opencover.xml" -type f | head -1)
            head -50 "$FIRST_FILE" | grep -E "(fullPath|SequencePoint)" | head -10 || true

            # Merge all coverage files into one OpenCover format
            reportgenerator \
              "-reports:./TestResults/**/coverage.opencover.xml" \
              "-targetdir:./coverage" \
              "-reporttypes:OpenCover" \
              "-verbosity:Warning"

            echo ""
            echo "=== Merged coverage report ==="
            if [ -f ./coverage/OpenCover.xml ]; then
              # Rename to expected name
              mv ./coverage/OpenCover.xml ./coverage/coverage.opencover.xml
              echo "Coverage file ready at ./coverage/coverage.opencover.xml"
              # Show file size to verify content
              ls -la ./coverage/coverage.opencover.xml
              # Show sample of merged file
              echo ""
              echo "=== Merged file header ==="
              head -30 ./coverage/coverage.opencover.xml
              echo ""
              echo "=== File path samples from merged report ==="
              grep -oP 'fullPath="[^"]*"' ./coverage/coverage.opencover.xml | head -5 || true
            fi

          else
            echo "WARNING: No coverage files found!"
          fi

          echo ""
          echo "=== All coverage files for SonarCloud ==="
          find . -name "coverage.opencover.xml" | head -20

      - name: End SonarQube analysis
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: dotnet sonarscanner end /d:sonar.token="${SONAR_TOKEN}"

      - name: Upload coverage reports
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: coverage-reports
          path: |
            ./coverage/coverage.opencover.xml
            ./TestResults/**/coverage.opencover.xml
            ./TestResults/**/*.trx
          retention-days: 7
