@page "/admin/audit"
@using Ceiba.Core.Interfaces
@using Ceiba.Shared.DTOs
@using Microsoft.AspNetCore.Authorization
@inject IAuditService AuditService
@inject ILogger<AuditLogViewer> Logger
@attribute [Authorize(Roles = "ADMIN")]

<PageTitle>Registro de Auditoría</PageTitle>

<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <h2><i class="bi bi-shield-check me-2"></i>Registro de Auditoría</h2>
            <p class="text-muted">Visualice todas las acciones realizadas en el sistema</p>
        </div>
    </div>

    <!-- Filters -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label">Código de Acción</label>
                            <select class="form-select" @bind="FilterCodigo" @bind:after="ApplyFilters">
                                <option value="">Todos</option>
                                @foreach (var auditCode in AuditCodesList)
                                {
                                    <option value="@auditCode.Code">@auditCode.Code - @auditCode.Description</option>
                                }
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Desde</label>
                            <input type="date" class="form-control" @bind="FilterFechaDesde" @bind:after="ApplyFilters" />
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Hasta</label>
                            <input type="date" class="form-control" @bind="FilterFechaHasta" @bind:after="ApplyFilters" />
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Usuario (ID)</label>
                            <input type="text" class="form-control" placeholder="GUID del usuario"
                                   @bind="FilterUsuarioId" @bind:after="ApplyFilters" />
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button class="btn btn-secondary w-100" @onclick="ClearFilters">
                                <i class="bi bi-x-circle me-1"></i>Limpiar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Results -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-body">
                    @if (IsLoading)
                    {
                        <div class="text-center py-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Cargando...</span>
                            </div>
                            <p class="mt-3">Cargando registros de auditoría...</p>
                        </div>
                    }
                    else if (!string.IsNullOrEmpty(ErrorMessage))
                    {
                        <div class="alert alert-danger">@ErrorMessage</div>
                    }
                    else if (!AuditLogs.Any())
                    {
                        <div class="text-center py-5 text-muted">
                            <i class="bi bi-journal-x" style="font-size: 3rem;"></i>
                            <p class="mt-3">No hay registros de auditoría para mostrar.</p>
                        </div>
                    }
                    else
                    {
                        <div class="table-responsive">
                            <table class="table table-hover table-sm">
                                <thead>
                                    <tr>
                                        <th>Fecha/Hora</th>
                                        <th>Código</th>
                                        <th>Usuario</th>
                                        <th>Tabla</th>
                                        <th>ID Relacionado</th>
                                        <th>IP</th>
                                        <th>Detalles</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var log in AuditLogs)
                                    {
                                        <tr>
                                            <td class="text-nowrap">
                                                @log.CreatedAt.ToLocalTime().ToString("dd/MM/yyyy HH:mm:ss")
                                            </td>
                                            <td>
                                                <span class="badge @GetCodeBadgeClass(log.Codigo)">
                                                    @log.Codigo
                                                </span>
                                            </td>
                                            <td>
                                                <small class="text-muted" title="@log.UsuarioId">
                                                    @(string.IsNullOrEmpty(log.UsuarioEmail) ? log.UsuarioId?.ToString()?.Substring(0, 8) ?? "Sistema" : log.UsuarioEmail)
                                                </small>
                                            </td>
                                            <td>@log.TablaRelacionada</td>
                                            <td>@log.IdRelacionado</td>
                                            <td><small>@log.Ip</small></td>
                                            <td>
                                                @if (!string.IsNullOrEmpty(log.Detalles))
                                                {
                                                    <button class="btn btn-sm btn-link p-0" @onclick="() => ShowDetails(log)">
                                                        <i class="bi bi-eye"></i> Ver
                                                    </button>
                                                }
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>

                        <!-- Pagination -->
                        @if (TotalPages > 1)
                        {
                            <nav aria-label="Paginación">
                                <ul class="pagination justify-content-center mb-0">
                                    <li class="page-item @(CurrentPage == 1 ? "disabled" : "")">
                                        <button class="page-link" @onclick="() => ChangePage(CurrentPage - 1)">Anterior</button>
                                    </li>
                                    @for (int i = Math.Max(1, CurrentPage - 2); i <= Math.Min(TotalPages, CurrentPage + 2); i++)
                                    {
                                        var pageNumber = i;
                                        <li class="page-item @(CurrentPage == pageNumber ? "active" : "")">
                                            <button class="page-link" @onclick="() => ChangePage(pageNumber)">@pageNumber</button>
                                        </li>
                                    }
                                    <li class="page-item @(CurrentPage == TotalPages ? "disabled" : "")">
                                        <button class="page-link" @onclick="() => ChangePage(CurrentPage + 1)">Siguiente</button>
                                    </li>
                                </ul>
                            </nav>
                            <p class="text-center text-muted mt-2">
                                Mostrando @AuditLogs.Count registros (Página @CurrentPage de @TotalPages)
                            </p>
                        }
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Details Modal -->
@if (ShowDetailsModal)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Detalles del Registro</h5>
                    <button type="button" class="btn-close" @onclick="() => ShowDetailsModal = false"></button>
                </div>
                <div class="modal-body">
                    @if (SelectedLog != null)
                    {
                        <dl class="row">
                            <dt class="col-sm-3">Fecha/Hora</dt>
                            <dd class="col-sm-9">@SelectedLog.CreatedAt.ToLocalTime().ToString("dd/MM/yyyy HH:mm:ss")</dd>

                            <dt class="col-sm-3">Código</dt>
                            <dd class="col-sm-9">
                                <span class="badge @GetCodeBadgeClass(SelectedLog.Codigo)">@SelectedLog.Codigo</span>
                                @SelectedLog.CodigoDescripcion
                            </dd>

                            <dt class="col-sm-3">Usuario ID</dt>
                            <dd class="col-sm-9">@SelectedLog.UsuarioId</dd>

                            <dt class="col-sm-3">Usuario</dt>
                            <dd class="col-sm-9">@SelectedLog.UsuarioEmail</dd>

                            <dt class="col-sm-3">Tabla</dt>
                            <dd class="col-sm-9">@SelectedLog.TablaRelacionada</dd>

                            <dt class="col-sm-3">ID Relacionado</dt>
                            <dd class="col-sm-9">@SelectedLog.IdRelacionado</dd>

                            <dt class="col-sm-3">IP</dt>
                            <dd class="col-sm-9">@SelectedLog.Ip</dd>

                            <dt class="col-sm-3">Detalles</dt>
                            <dd class="col-sm-9">
                                <pre class="bg-light p-3 rounded" style="max-height: 300px; overflow-y: auto;">@SelectedLog.Detalles</pre>
                            </dd>
                        </dl>
                    }
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" @onclick="() => ShowDetailsModal = false">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private List<AuditLogEntryDto> AuditLogs { get; set; } = new();
    private bool IsLoading { get; set; } = true;
    private string? ErrorMessage { get; set; }

    // Pagination
    private int CurrentPage { get; set; } = 1;
    private int PageSize { get; set; } = 50;
    private int TotalCount { get; set; } = 0;
    private int TotalPages => (int)Math.Ceiling((double)TotalCount / PageSize);

    // Filters
    private string? FilterCodigo { get; set; }
    private DateTime? FilterFechaDesde { get; set; }
    private DateTime? FilterFechaHasta { get; set; }
    private string? FilterUsuarioId { get; set; }

    // Details modal
    private bool ShowDetailsModal { get; set; }
    private AuditLogEntryDto? SelectedLog { get; set; }

    // Audit codes list
    private static readonly List<(string Code, string Description)> AuditCodesList = new()
    {
        (AuditCodes.AUTH_LOGIN, "Inicio de sesión"),
        (AuditCodes.AUTH_LOGOUT, "Cierre de sesión"),
        (AuditCodes.AUTH_FAILED, "Intento fallido de login"),
        (AuditCodes.AUTH_LOCKED, "Cuenta bloqueada"),
        (AuditCodes.USER_CREATE, "Usuario creado"),
        (AuditCodes.USER_UPDATE, "Usuario actualizado"),
        (AuditCodes.USER_SUSPEND, "Usuario suspendido"),
        (AuditCodes.USER_ACTIVATE, "Usuario activado"),
        (AuditCodes.USER_DELETE, "Usuario eliminado"),
        (AuditCodes.REPORT_CREATE, "Reporte creado"),
        (AuditCodes.REPORT_UPDATE, "Reporte actualizado"),
        (AuditCodes.REPORT_SUBMIT, "Reporte entregado"),
        (AuditCodes.REPORT_EXPORT, "Reporte exportado"),
        (AuditCodes.REPORT_EXPORT_BULK, "Exportación masiva"),
        (AuditCodes.CATALOG_CREATE, "Catálogo creado"),
        (AuditCodes.CATALOG_UPDATE, "Catálogo actualizado"),
        (AuditCodes.CATALOG_DELETE, "Catálogo eliminado"),
        (AuditCodes.ACCESS_DENIED, "Acceso denegado"),
        (AuditCodes.SESSION_EXPIRED, "Sesión expirada")
    };

    protected override async Task OnInitializedAsync()
    {
        await LoadAuditLogsAsync();
    }

    private async Task LoadAuditLogsAsync()
    {
        IsLoading = true;
        ErrorMessage = null;

        try
        {
            Guid? usuarioId = null;
            if (!string.IsNullOrWhiteSpace(FilterUsuarioId) && Guid.TryParse(FilterUsuarioId, out var parsedId))
            {
                usuarioId = parsedId;
            }

            var logs = await AuditService.QueryAsync(
                usuarioId: usuarioId,
                codigo: FilterCodigo,
                fechaInicio: FilterFechaDesde,
                fechaFin: FilterFechaHasta?.AddDays(1), // Include the entire end day
                skip: (CurrentPage - 1) * PageSize,
                take: PageSize
            );

            AuditLogs = logs.Select(log => new AuditLogEntryDto
            {
                Id = log.Id,
                Codigo = log.Codigo,
                CodigoDescripcion = AuditCodes.GetDescription(log.Codigo),
                IdRelacionado = log.IdRelacionado,
                TablaRelacionada = log.TablaRelacionada,
                CreatedAt = log.CreatedAt,
                UsuarioId = log.UsuarioId,
                UsuarioEmail = log.UsuarioNombre,
                Ip = log.Ip,
                Detalles = log.Detalles
            }).ToList();

            // Note: For proper pagination, we'd need a count query
            TotalCount = AuditLogs.Count == PageSize ? (CurrentPage * PageSize) + 1 : (CurrentPage - 1) * PageSize + AuditLogs.Count;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading audit logs");
            ErrorMessage = "Error al cargar los registros de auditoría.";
        }
        finally
        {
            IsLoading = false;
        }
    }

    private async Task ApplyFilters()
    {
        CurrentPage = 1;
        await LoadAuditLogsAsync();
    }

    private async Task ClearFilters()
    {
        FilterCodigo = null;
        FilterFechaDesde = null;
        FilterFechaHasta = null;
        FilterUsuarioId = null;
        CurrentPage = 1;
        await LoadAuditLogsAsync();
    }

    private async Task ChangePage(int page)
    {
        if (page < 1) return;
        CurrentPage = page;
        await LoadAuditLogsAsync();
    }

    private void ShowDetails(AuditLogEntryDto log)
    {
        SelectedLog = log;
        ShowDetailsModal = true;
    }

    private static string GetCodeBadgeClass(string code)
    {
        return code switch
        {
            var c when c.StartsWith("AUTH_FAILED") || c.StartsWith("AUTH_LOCKED") => "bg-danger",
            var c when c.StartsWith("AUTH_") => "bg-info",
            var c when c.StartsWith("USER_") => "bg-primary",
            var c when c.StartsWith("REPORT_") => "bg-success",
            var c when c.StartsWith("CATALOG_") => "bg-warning text-dark",
            var c when c.StartsWith("ACCESS_DENIED") || c.StartsWith("SESSION_") => "bg-danger",
            _ => "bg-secondary"
        };
    }
}
